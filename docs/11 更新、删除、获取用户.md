# 11. 更新、删除、获取用户功能

## 概述

本文档详细描述了用户管理系统的核心功能：获取用户信息、更新用户信息和删除用户账户。这些功能都基于JWT认证中间件，确保只有经过认证的用户才能访问自己的信息。

## 功能架构

### 整体架构

```sh
HTTP API (端口: 8099) → Nginx网关 → API服务 (端口: 8888) → RPC服务 (端口: 8889) → 数据库
```

### 认证流程

1. 用户通过登录接口获取JWT token
2. API层中间件解析token，提取用户ID
3. API层调用RPC时传递token
4. RPC层拦截器验证token，提取用户ID
5. 业务逻辑验证用户权限

## 1. 获取用户信息功能

### 1.1 功能描述

获取当前登录用户的详细信息，包括基本信息、状态、创建时间等。

### 1.2 API接口

- **路径**: `GET /api/user/`
- **认证**: 需要JWT token
- **权限**: 只能获取自己的用户信息

### 1.3 实现细节

#### API层实现

**文件**: `apps/user/api/internal/logic/getuserlogic.go`

关键实现点：

- 从context中获取用户ID（由中间件设置）
- 从context中获取原始token
- 创建带token的gRPC上下文传递给RPC服务
- 使用统一的错误处理机制

#### RPC层实现

**文件**: `apps/user/rpc/internal/logic/getuserlogic.go`

关键实现点：

- 验证用户权限（只能查看自己的信息）
- 检查用户状态（禁用用户无法获取信息）
- 从数据库查询用户信息
- 格式化时间字段

### 1.4 响应格式

```json
{
    "code": 0,
    "message": "ok",
    "data": {
        "userId": "mu-nju8c0",
        "username": "alice",
        "email": "alice@example.com",
        "phone": "13800138000",
        "age": 25,
        "gender": 1,
        "avatar": "https://example.com/avatar.png",
        "status": 1,
        "createdAt": "2025-08-22 09:44:54",
        "updatedAt": "2025-08-22 11:49:13"
    },
    "reason": ""
}

## 2. 更新用户信息功能

### 2.1 功能描述
更新当前登录用户的基本信息，包括用户名、年龄、性别、头像等。

### 2.2 API接口
- **路径**: `PUT /api/user/`
- **认证**: 需要JWT token
- **权限**: 只能更新自己的用户信息

### 2.3 请求参数
```json
{
    "userId": "mu-nju8c0",
    "username": "alice_updated",
    "age": 26,
    "gender": 1,
    "avatar": "https://example.com/new_avatar.jpg"
}
```

### 2.4 实现细节

#### API层实现

**文件**: `apps/user/api/internal/logic/updateuserlogic.go`

关键实现点：

- 从context中获取用户ID和token
- 调用RPC服务更新用户信息
- 使用统一的错误处理机制

#### RPC层实现

**文件**: `apps/user/rpc/internal/logic/updateuserlogic.go`

关键实现点：

- 验证用户权限（只能更新自己的信息）
- 检查用户状态（禁用用户无法更新信息）
- 部分字段更新（只更新非空字段）
- 数据库事务处理

### 2.5 响应格式

```json
{
    "code": 0,
    "message": "ok",
    "data": {
        "userId": "mu-nju8c0",
        "username": "alice_updated",
        "updatedAt": ""
    },
    "reason": ""
}
```

## 3. 删除用户功能

### 3.1 功能描述

删除当前登录用户的账户，采用软删除策略，将用户状态设置为禁用。

### 3.2 API接口

- **路径**: `DELETE /api/user/`
- **认证**: 需要JWT token
- **权限**: 只能删除自己的账户

### 3.3 请求参数

```json
{
    "userId": "mu-nju8c0"
}
```

### 3.4 实现细节

#### API层实现

**文件**: `apps/user/api/internal/logic/deleteuserlogic.go`

关键实现点：

- 从context中获取用户ID和token
- 调用RPC服务删除用户
- 使用统一的错误处理机制

#### RPC层实现

**文件**: `apps/user/rpc/internal/logic/deleteuserlogic.go`

关键实现点：

- 验证用户权限（只能删除自己的账户）
- 检查用户状态（已禁用用户无法再次删除）
- 软删除策略（设置状态为0，不真正删除数据）
- 数据完整性保护

### 3.5 响应格式

```json
{
    "code": 0,
    "message": "ok",
    "data": {
        "success": true
    },
    "reason": ""
}
```

## 4. 权限控制设计

### 4.1 认证中间件

**文件**: `pkg/middleware/authn.go`

- HTTP中间件：解析JWT token，提取用户ID
- gRPC拦截器：验证token，提取用户ID
- 白名单机制：登录和注册接口不需要认证

### 4.2 权限验证

- **用户隔离**：用户只能操作自己的信息
- **状态检查**：禁用用户无法进行任何操作
- **Token验证**：每次请求都验证token的有效性

### 4.3 错误处理

- **401 Unauthorized**：token无效或过期
- **403 Forbidden**：用户被禁用
- **404 Not Found**：用户不存在
- **500 Internal Server Error**：服务器内部错误

## 5. 数据安全考虑

### 5.1 软删除策略

- 删除用户时只设置状态为禁用
- 保留用户数据用于审计和恢复
- 避免级联删除影响其他业务

### 5.2 字段验证

- 用户名长度限制：3-100字符
- 年龄范围：1-120岁
- 性别枚举：0-未设置，1-男，2-女，3-其他
- 邮箱格式验证

### 5.3 数据一致性

- 使用数据库事务确保数据一致性
- 缓存更新机制保证数据同步
- 并发控制避免数据竞争

## 6. 性能优化

### 6.1 缓存策略

- 用户信息缓存减少数据库查询
- 缓存失效机制保证数据新鲜度
- 分布式缓存支持高并发

### 6.2 数据库优化

- 索引优化：用户ID、邮箱、手机号等字段
- 查询优化：只查询必要字段
- 连接池管理：复用数据库连接

### 6.3 日志记录

- 结构化日志便于问题排查
- 操作审计记录用户行为
- 性能监控记录响应时间

## 7. 测试用例

### 7.1 功能测试

- 正常获取用户信息
- 正常更新用户信息
- 正常删除用户账户
- 权限验证测试
- 错误处理测试

### 7.2 边界测试

- 无效token测试
- 过期token测试
- 权限不足测试
- 用户不存在测试
- 用户已禁用测试

### 7.3 性能测试

- 并发请求测试
- 大数据量测试
- 长时间运行测试

## 8. 部署和监控

### 8.1 服务部署

- Docker容器化部署
- 服务健康检查
- 自动重启机制

### 8.2 监控指标

- 请求成功率
- 响应时间
- 错误率统计
- 用户活跃度

### 8.3 告警机制

- 服务异常告警
- 性能指标告警
- 安全事件告警

## 总结

用户管理功能采用了分层架构设计，通过JWT认证确保安全性，通过软删除策略保护数据完整性，通过统一的错误处理机制提供良好的用户体验。整个系统具有良好的可扩展性和可维护性，能够满足高并发场景下的用户管理需求。
