# 参数校验系统

## 概述

本项目使用基于 `govalidator` 库构建的自定义参数校验系统，提供了丰富的验证规则和灵活的扩展能力。该系统遵循职责单一原则，符合 Go 语言规范，并提供了详细的错误信息。

## 系统架构

### 文件结构

```
pkg/validate/
├── validate.go      # 核心验证接口和主要功能
├── validators.go    # 具体验证函数实现
├── rules.go         # 验证规则定义和常量
├── errors.go        # 错误类型定义和错误处理
└── validate_test.go # 完整的测试用例
```

### 核心组件

1. **`validate.go`** - 提供主要的验证接口和结构体验证功能
2. **`validators.go`** - 实现各种具体的验证函数
3. **`rules.go`** - 定义验证规则常量和规则管理
4. **`errors.go`** - 定义错误类型和错误处理机制
5. **`validate_test.go`** - 提供完整的测试覆盖

## 支持的验证规则

### 基础验证规则

| 规则 | 描述 | 示例 | 适用类型 |
|------|------|------|----------|
| `required` | 字段不能为空 | `valid:"required"` | 所有类型 |
| `email` | 邮箱格式验证 | `valid:"required,email"` | string |
| `url` | URL格式验证 | `valid:"url"` | string |
| `uuid` | UUID格式验证 | `valid:"uuid"` | string |
| `json` | JSON格式验证 | `valid:"json"` | string |

### 字符类型验证规则

| 规则 | 描述 | 示例 | 适用类型 |
|------|------|------|----------|
| `alpha` | 只能包含字母 | `valid:"alpha"` | string |
| `numeric` | 只能包含数字 | `valid:"numeric"` | string |
| `alphanum` | 只能包含字母、数字和下划线 | `valid:"alphanum"` | string |
| `ascii` | 只能包含ASCII字符 | `valid:"ascii"` | string |

### 网络相关验证规则

| 规则 | 描述 | 示例 | 适用类型 |
|------|------|------|----------|
| `ipv4` | IPv4地址验证 | `valid:"ipv4"` | string |
| `ipv6` | IPv6地址验证 | `valid:"ipv6"` | string |
| `port` | 端口号验证 | `valid:"port"` | string |
| `dns` | DNS名称验证 | `valid:"dns"` | string |
| `host` | 主机名验证 | `valid:"host"` | string |
| `mac` | MAC地址验证 | `valid:"mac"` | string |

### 数据格式验证规则

| 规则 | 描述 | 示例 | 适用类型 |
|------|------|------|----------|
| `base64` | Base64编码验证 | `valid:"base64"` | string |
| `datauri` | Data URI验证 | `valid:"datauri"` | string |
| `rfc3339` | RFC3339时间格式验证 | `valid:"rfc3339"` | string |
| `semver` | 语义化版本验证 | `valid:"semver"` | string |
| `ulid` | ULID格式验证 | `valid:"ulid"` | string |
| `yyyymmdd` | YYYYMMDD日期格式验证 | `valid:"yyyymmdd"` | string |

### 地理位置验证规则

| 规则 | 描述 | 示例 | 适用类型 |
|------|------|------|----------|
| `latitude` | 纬度验证 | `valid:"latitude"` | string |
| `longitude` | 经度验证 | `valid:"longitude"` | string |

### 带参数的验证规则

| 规则 | 描述 | 示例 | 适用类型 |
|------|------|------|----------|
| `length(min\|max)` | 字符串长度验证 | `valid:"length(3\|20)"` | string |
| `range(min\|max)` | 数值范围验证 | `valid:"range(1\|100)"` | 数值类型 |
| `matches(pattern)` | 正则表达式验证 | `valid:"matches(^1[3-9]\\d{9}$)"` | string |
| `in(value1\|value2\|...)` | 枚举值验证 | `valid:"in(active\|inactive)"` | 所有类型 |

## 使用方法

### 1. 导入包

```go
import "github.com/clin211/miniblog-v3/pkg/validate"
```

### 2. 定义结构体

```go
type User struct {
    ID        string    `json:"id" valid:"required,uuid"`
    Username  string    `json:"username" valid:"required,alphanum,length(3|20)"`
    Email     string    `json:"email" valid:"required,email"`
    Password  string    `json:"password" valid:"required,length(6|50)"`
    Age       int       `json:"age" valid:"range(1|120)"`
    Phone     string    `json:"phone" valid:"matches(^1[3-9]\\d{9}$)"`
    Gender    string    `json:"gender" valid:"in(male|female|other)"`
    Status    string    `json:"status" valid:"in(active|inactive|pending)"`
    CreatedAt time.Time `json:"created_at" valid:"-"`
    UpdatedAt time.Time `json:"updated_at" valid:"-"`
}
```

### 3. 执行验证

```go
user := &User{
    ID:       "550e8400-e29b-41d4-a716-446655440000",
    Username: "john_doe",
    Email:    "john@example.com",
    Password: "password123",
    Age:      25,
    Phone:    "13800138000",
    Gender:   "male",
    Status:   "active",
}

if err := validate.ValidateStructWithCustomRules(user); err != nil {
    // 处理验证错误
    handleValidationError(err)
} else {
    // 验证通过，继续处理
    processUser(user)
}
```

### 4. 错误处理

```go
func handleValidationError(err error) {
    switch e := err.(type) {
    case validate.ValidationErrors:
        // 处理多个验证错误
        for _, validationError := range e {
            fmt.Printf("字段: %s, 错误: %s, 值: %v\n", 
                validationError.Field, 
                validationError.Message, 
                validationError.Value)
        }
    default:
        // 处理其他错误
        fmt.Printf("验证错误: %v\n", err)
    }
}
```

## 常用验证规则组合

### 用户相关验证

```go
type User struct {
    // 用户名：必填，字母数字下划线，3-20字符
    Username string `json:"username" valid:"required,alphanum,length(3|20)"`
    
    // 邮箱：必填，有效邮箱格式
    Email string `json:"email" valid:"required,email"`
    
    // 密码：必填，6-50字符
    Password string `json:"password" valid:"required,length(6|50)"`
    
    // 手机号：中国手机号格式
    Phone string `json:"phone" valid:"matches(^1[3-9]\\d{9}$)"`
    
    // 年龄：1-120岁
    Age int `json:"age" valid:"range(1|120)"`
    
    // 性别：枚举值
    Gender string `json:"gender" valid:"in(male|female|other)"`
    
    // 状态：枚举值
    Status string `json:"status" valid:"in(active|inactive|pending)"`
}
```

### 文章相关验证

```go
type Post struct {
    // 标题：必填，1-100字符
    Title string `json:"title" valid:"required,length(1|100)"`
    
    // 内容：必填，10-10000字符
    Content string `json:"content" valid:"required,length(10|10000)"`
    
    // 分类：枚举值
    Category string `json:"category" valid:"in(tech|life|news|other)"`
    
    // 标签：可选，跳过验证
    Tags []string `json:"tags" valid:"-"`
}
```

### 评论相关验证

```go
type Comment struct {
    // 评论内容：必填，1-500字符
    Content string `json:"content" valid:"required,length(1|500)"`
    
    // 父评论ID：可选，UUID格式
    ParentID *string `json:"parent_id" valid:"uuid"`
}
```

## 预定义验证规则常量

### 长度规则常量

```go
// 使用预定义的长度规则
Username string `json:"username" valid:"required,alphanum,length(3|20)"`
Password string `json:"password" valid:"required,length(6|50)"`
Email    string `json:"email" valid:"required,email,length(5|254)"`
Phone    string `json:"phone" valid:"length(11|11)"`
Code     string `json:"code" valid:"length(4|6)"`
```

### 范围规则常量

```go
// 使用预定义的范围规则
Age   int `json:"age" valid:"range(1|120)"`
Score int `json:"score" valid:"range(0|100)"`
Price int `json:"price" valid:"range(0|999999)"`
```

### 正则表达式规则常量

```go
// 使用预定义的正则表达式规则
Phone     string `json:"phone" valid:"matches(^1[3-9]\\d{9}$)"`
IDCard    string `json:"id_card" valid:"matches(^[1-9]\\d{5}(18|19|20)\\d{2}((0[1-9])|(1[0-2]))(([0-2][1-9])|10|20|30|31)\\d{3}[0-9Xx]$)"`
ChineseName string `json:"chinese_name" valid:"matches(^[\\u4e00-\\u9fa5]{2,4}$)"`
EnglishName string `json:"english_name" valid:"matches(^[a-zA-Z\\s]{2,50}$)"`
```

### 枚举值规则常量

```go
// 使用预定义的枚举值规则
Gender string `json:"gender" valid:"in(male|female|other)"`
Status string `json:"status" valid:"in(active|inactive|pending|deleted)"`
Type   string `json:"type" valid:"in(user|admin|moderator)"`
```

## 错误处理详解

### 错误类型

```go
// 单个验证错误
type ValidationError struct {
    Field   string      `json:"field"`   // 字段名
    Message string      `json:"message"` // 错误消息
    Value   interface{} `json:"value"`   // 字段值
}

// 多个验证错误
type ValidationErrors []*ValidationError
```

### 错误处理示例

```go
func validateUserData(user *User) error {
    if err := validate.ValidateStructWithCustomRules(user); err != nil {
        switch e := err.(type) {
        case validate.ValidationErrors:
            // 收集所有错误信息
            var errorMessages []string
            for _, validationError := range e {
                errorMessages = append(errorMessages, 
                    fmt.Sprintf("%s: %s", validationError.Field, validationError.Message))
            }
            return fmt.Errorf("验证失败: %s", strings.Join(errorMessages, "; "))
            
        default:
            return fmt.Errorf("验证错误: %v", err)
        }
    }
    return nil
}
```

### 错误信息国际化

```go
func getLocalizedErrorMessage(field, rule string) string {
    // 根据字段和规则返回本地化的错误消息
    messages := map[string]map[string]string{
        "Username": {
            "required": "用户名不能为空",
            "alphanum": "用户名只能包含字母、数字和下划线",
            "length": "用户名长度必须在3-20个字符之间",
        },
        "Email": {
            "required": "邮箱不能为空",
            "email": "邮箱格式不正确",
        },
        // ... 更多字段和规则
    }
    
    if fieldMessages, exists := messages[field]; exists {
        if message, exists := fieldMessages[rule]; exists {
            return message
        }
    }
    
    return fmt.Sprintf("字段 %s 验证失败", field)
}
```

## 性能优化

### 性能特点

- **高效验证**: 单次验证耗时约 12μs
- **内存优化**: 低内存占用
- **并发安全**: 支持并发验证
- **缓存友好**: 验证规则解析结果可缓存

### 性能测试

```go
func BenchmarkValidation(b *testing.B) {
    user := &User{
        ID:       "550e8400-e29b-41d4-a716-446655440000",
        Username: "john_doe",
        Email:    "john@example.com",
        Password: "password123",
        Age:      25,
        Phone:    "13800138000",
        Gender:   "male",
        Status:   "active",
    }
    
    b.ResetTimer()
    for i := 0; i < b.N; i++ {
        validate.ValidateStructWithCustomRules(user)
    }
}
```

### 性能优化建议

1. **避免重复验证**: 在业务逻辑中避免对同一数据进行重复验证
2. **合理使用规则**: 选择必要的验证规则，避免过度验证
3. **缓存验证结果**: 对于频繁验证的数据，可以考虑缓存验证结果
4. **批量验证**: 对于大量数据，考虑批量验证而不是逐个验证

## 扩展自定义验证规则

### 添加新的验证函数

```go
// 在 validators.go 中添加新的验证函数
func validateCustom(field reflect.Value, fieldType reflect.StructField) error {
    if field.IsZero() {
        return nil
    }
    
    if field.Kind() != reflect.String {
        return fmt.Errorf("字段必须是字符串类型")
    }
    
    value := field.String()
    // 实现自定义验证逻辑
    if !isValidCustomValue(value) {
        return fmt.Errorf("自定义验证失败")
    }
    
    return nil
}

// 在 applySimpleRule 函数中添加新的规则
case "custom":
    return validateCustom(field, fieldType)
```

### 添加带参数的验证规则

```go
// 在 validators.go 中添加新的带参数验证函数
func validateCustomWithParams(field reflect.Value, fieldType reflect.StructField, params []string) error {
    if field.IsZero() {
        return nil
    }
    
    // 解析参数
    if len(params) == 0 {
        return fmt.Errorf("custom规则需要参数")
    }
    
    // 实现自定义验证逻辑
    return nil
}

// 在 applyParametricRule 函数中添加新的规则
case "custom":
    return validateCustomWithParams(field, fieldType, params)
```

## 测试

### 运行测试

```bash
# 运行所有测试
go test ./pkg/validate -v

# 运行性能测试
go test ./pkg/validate -bench=.

# 运行测试覆盖率
go test ./pkg/validate -cover

# 运行特定测试
go test ./pkg/validate -run TestEmailValidation
```

### 测试用例示例

```go
func TestEmailValidation(t *testing.T) {
    testCases := []struct {
        email string
        valid bool
    }{
        {"test@example.com", true},
        {"invalid-email", false},
        {"test@", false},
        {"@example.com", false},
        {"", false}, // 空值应该验证失败（因为有required标签）
    }
    
    for _, tc := range testCases {
        user := &User{
            ID:       "550e8400-e29b-41d4-a716-446655440000",
            Username: "testuser",
            Email:    tc.email,
            Password: "password123",
        }
        
        err := validate.ValidateStructWithCustomRules(user)
        if tc.valid && err != nil {
            t.Errorf("邮箱 %s 应该有效，但验证失败: %v", tc.email, err)
        }
        if !tc.valid && err == nil {
            t.Errorf("邮箱 %s 应该无效，但验证通过", tc.email)
        }
    }
}
```

## 最佳实践

### 1. 验证规则设计

- **明确性**: 验证规则应该明确表达业务需求
- **一致性**: 相同类型的字段使用相同的验证规则
- **可维护性**: 使用预定义的常量而不是硬编码的规则字符串

### 2. 错误处理

- **用户友好**: 提供清晰、易懂的错误消息
- **完整性**: 收集所有验证错误，而不是在第一个错误时停止
- **国际化**: 考虑错误消息的国际化需求

### 3. 性能考虑

- **必要性**: 只验证必要的字段，避免过度验证
- **缓存**: 对于频繁验证的数据考虑缓存
- **批量处理**: 对于大量数据考虑批量验证

### 4. 代码组织

- **职责分离**: 验证逻辑与业务逻辑分离
- **可测试性**: 验证函数应该是可测试的
- **可扩展性**: 设计时考虑未来可能的扩展需求

## 注意事项

1. **验证标签**: 使用 `valid` 字段作为验证标签
2. **规则分隔**: 多个规则用逗号分隔
3. **参数分隔**: 带参数的规则使用 `|` 分隔参数
4. **跳过验证**: 使用 `-` 跳过验证
5. **空值处理**: 空值默认跳过验证（除非有 `required` 标签）
6. **类型安全**: 确保验证规则与字段类型匹配
7. **正则表达式**: 在字符串中使用双反斜杠转义

## 依赖

- `github.com/asaskevich/govalidator` - 基础验证库
- Go 1.24.2+

## 相关链接

- [govalidator 官方文档](https://github.com/asaskevich/govalidator)
- [Go 语言反射包文档](https://golang.org/pkg/reflect/)
- [Go 语言测试包文档](https://golang.org/pkg/testing/)
