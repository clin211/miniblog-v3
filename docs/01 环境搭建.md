# MiniBlog 环境搭建指南

本文档描述了 MiniBlog 项目的开发环境搭建过程。我们采用**极简设计**，只需要一个 `docker-compose.env.yml` 文件即可启动 MySQL、Redis、Kafka 等所有基础服务，无需额外的配置文件或脚本。

## 📋 环境要求

- **Docker**: 20.10 或更高版本
- **Docker Compose**: 2.0 或更高版本  
- **系统内存**: 至少 4GB 可用内存
- **磁盘空间**: 至少 10GB 可用磁盘空间
- **操作系统**: macOS、Linux 或 Windows

> 💡 **极简原则**: 整个环境只需要一个配置文件，无需学习复杂的 Makefile 或脚本命令。

## 🏗️ 服务架构

### 核心服务

| 服务 | 版本 | 端口 | 说明 |
|------|------|------|------|
| MySQL | 8.0 | 3306 | 主数据库 |
| Redis | 7-alpine | 6379 | 缓存数据库 |
| Kafka | 7.4.0 | 9092 | 消息队列 |
| Zookeeper | 7.4.0 | 2181 | Kafka 协调服务 |

### 可观测性组件

| 服务 | 版本 | 端口 | 说明 |
|------|------|------|------|
| Elasticsearch | 8.8.0 | 9200 | 日志存储引擎 |
| Filebeat | 8.8.0 | - | 日志采集器 |
| go-stash | latest | - | 日志处理器 |
| Prometheus | 2.44.0 | 9090 | 指标收集器 |
| Grafana | 9.5.0 | 3000 | 监控可视化 |
| Jaeger | 1.46 | 16686 | 链路追踪 |

### 管理界面

| 服务 | 端口 | 访问地址 | 用户名 | 密码 | 说明 |
|------|------|----------|--------|------|------|
| Kafka UI | 8080 | <http://localhost:8080> | - | - | Kafka 管理界面 |
| Kibana | 5601 | <http://localhost:5601> | - | - | 日志分析界面 |
| Grafana | 3000 | <http://localhost:3000> | admin | admin123 | 监控可视化界面 |
| Jaeger | 16686 | <http://localhost:16686> | - | - | 链路追踪界面 |
| Prometheus | 9090 | <http://localhost:9090> | - | - | 指标查询界面 |

### 服务配置信息

#### MySQL 配置

- **数据库名**: miniblog
- **用户名**: miniblog_user  
- **密码**: j478EaZGDNPUbnXb
- **Root密码**: j478EaZGDNPUbnXb
- **字符集**: utf8mb4
- **时区**: Asia/Shanghai (+08:00)

#### Redis 配置

- **密码**: weZ2014P89rlTuWe
- **内存限制**: 256MB
- **内存策略**: allkeys-lru
- **持久化**: AOF + RDB
- **最大连接数**: 10000

#### Kafka 配置

- **自动创建主题**: 启用
- **删除主题**: 启用
- **复制因子**: 1（单节点）

#### 可观测性配置

##### Elasticsearch 配置

- **集群模式**: 单节点
- **内存限制**: 512MB
- **安全认证**: 禁用（开发环境）
- **数据持久化**: 启用

##### Grafana 配置

- **管理员用户**: admin
- **管理员密码**: admin123
- **预装插件**: grafana-piechart-panel
- **数据源**: Prometheus

##### Jaeger 配置

- **收集器协议**: HTTP/gRPC/UDP
- **OTLP 支持**: 启用
- **存储引擎**: Badger（本地存储）

##### 日志收集配置

- **日志目录**: `deploy/dev/logs/`
- **Filebeat 输出**: Elasticsearch + Kafka
- **go-stash 处理**: Kafka → Elasticsearch

## 🚀 快速开始

### 使用 Docker Compose（简单直接）

⚠️ **重要网络配置**:

- 使用预先创建的外部网络 `miniblog-network`
- 基础环境服务和应用服务都连接到同一个外部网络
- `make env-start` 会自动创建网络并启动基础服务
- **建议先启动基础环境，再启动应用服务**

#### 1. 启动基础环境服务（必须先启动）

```bash
# 进入项目根目录
cd miniblog-v3

# 进入部署目录
cd deploy/dev

# 启动所有服务
docker compose -f docker-compose.env.yml up -d

# 查看服务状态
docker compose -f docker-compose.env.yml ps
```

#### 2. 服务管理

```bash
# 查看服务日志
docker compose -f docker-compose.env.yml logs -f

# 查看特定服务日志
docker compose -f docker-compose.env.yml logs mysql
docker compose -f docker-compose.env.yml logs redis
docker compose -f docker-compose.env.yml logs kafka

# 重启服务
docker compose -f docker-compose.env.yml restart

# 停止服务
docker compose -f docker-compose.env.yml down

# 停止并删除数据卷（完全清理）
docker compose -f docker-compose.env.yml down -v
```

#### 3. 配置验证

```bash
# 验证配置文件语法
docker compose -f docker-compose.env.yml config

# 检查服务是否正常启动
docker ps
```

## 🔍 服务连接与测试

### 连接数据库

```bash
# 连接 MySQL（root 用户）
docker exec -it miniblog-mysql mysql -u root -pj478EaZGDNPUbnXb

# 连接 MySQL（应用用户）
docker exec -it miniblog-mysql mysql -u miniblog_user -pj478EaZGDNPUbnXb miniblog

# 连接 Redis
docker exec -it miniblog-redis redis-cli -a weZ2014P89rlTuWe

# 进入 Kafka 容器
docker exec -it miniblog-kafka bash
```

### 服务健康检查

```bash
# 检查 MySQL 服务状态
docker exec miniblog-mysql mysqladmin ping -h localhost -u root -pj478EaZGDNPUbnXb

# 检查 Redis 服务状态
docker exec miniblog-redis redis-cli -a weZ2014P89rlTuWe ping

# 检查 Kafka 服务状态
docker exec miniblog-kafka kafka-topics --bootstrap-server localhost:9092 --list

# 查看所有容器状态
docker ps
```

### Kafka 主题管理

```bash
# 查看 Kafka 主题列表
docker exec miniblog-kafka kafka-topics --bootstrap-server localhost:9092 --list

# 创建测试主题
docker exec miniblog-kafka kafka-topics --bootstrap-server localhost:9092 --create --topic test-topic --partitions 1 --replication-factor 1

# 删除主题
docker exec miniblog-kafka kafka-topics --bootstrap-server localhost:9092 --delete --topic test-topic

# 查看主题详情
docker exec miniblog-kafka kafka-topics --bootstrap-server localhost:9092 --describe --topic test-topic
```

### 管理界面访问

```bash
# Kafka UI 管理界面
open http://localhost:8080

# Kibana 日志分析界面
open http://localhost:5601

# Grafana 监控可视化界面（用户名: admin, 密码: admin123）
open http://localhost:3000

# Jaeger 链路追踪界面
open http://localhost:16686

# Prometheus 指标查询界面
open http://localhost:9090

# 或在浏览器中直接访问对应地址
```

## ⚙️ 配置管理

### 🎯 极简配置原则

**一个文件搞定所有配置** - 所有服务配置都集中在 `deploy/dev/docker-compose.env.yml` 文件中：

- ✅ **环境变量**: 设置基本配置参数
- ✅ **启动命令**: 通过 `command` 参数设置详细配置  
- ✅ **无外部文件**: 不依赖额外的配置文件
- ✅ **零学习成本**: 只需要掌握 Docker Compose 基本命令

### 配置修改方法

1. **编辑配置文件**

   ```bash
   # 编辑主配置文件
   vi deploy/dev/docker-compose.env.yml
   ```

2. **重启服务**

   ```bash
   # 重启所有服务
   docker compose -f docker-compose.env.yml restart
   
   # 重启特定服务
   docker compose -f docker-compose.env.yml restart mysql
   docker compose -f docker-compose.env.yml restart redis
   docker compose -f docker-compose.env.yml restart kafka
   ```

### 常见配置修改

#### 修改密码

```yaml
# MySQL 密码修改
environment:
  MYSQL_ROOT_PASSWORD: 新密码
  MYSQL_PASSWORD: 新密码
command: >
  --default-authentication-plugin=mysql_native_password
  # ... 其他配置

# Redis 密码修改  
command: >
  redis-server
  --requirepass 新密码
  # ... 其他配置
```

#### 调整性能参数

```yaml
# MySQL 性能调优
command: >
  --max-connections=500          # 增加连接数
  --innodb-buffer-pool-size=512M # 增加缓冲池
  
# Redis 性能调优
command: >
  redis-server
  --maxmemory 512mb              # 增加内存限制
  --maxclients 20000             # 增加客户端数
```

## 🌐 网络配置

### 🏗️ 网络架构设计

项目采用**分层网络架构**，所有服务运行在同一个 Docker 网络中：

#### 网络管理方式

1. **手动创建外部网络** → `miniblog-network`
2. **基础环境** (`docker-compose.env.yml`) → 使用外部网络
3. **应用服务** (`docker-compose.yml`) → 使用外部网络

所有服务都连接到同一个预先创建的外部网络，确保完全的网络连通性。

#### 服务网络访问

所有服务都在 `miniblog-network` 网络中，服务间通过容器名访问：

**基础服务**:

- **MySQL**: `mysql:3306`
- **Redis**: `redis:6379`  
- **Kafka**: `kafka:29092`

- **Zookeeper**: `zookeeper:2181`

**可观测性服务**:

- **Elasticsearch**: `elasticsearch:9200`

- **Prometheus**: `prometheus:9090`
- **Jaeger**: `jaeger:14268` (collector)

**应用服务**:

- **User API**: `user-api:8888`
- **User RPC**: `user-rpc:8889`
- **Nginx**: `nginx:8099`

### 应用配置示例

```yaml
# 应用配置文件示例
database:
  host: mysql
  port: 3306
  username: miniblog_user
  password: j478EaZGDNPUbnXb
  database: miniblog

redis:
  host: redis
  port: 6379
  password: weZ2014P89rlTuWe

kafka:
  brokers:
    - kafka:29092

# 可观测性配置
telemetry:
  # 指标收集
  metrics:
    enabled: true
    endpoint: http://prometheus:9090

  # 链路追踪  
  tracing:
    enabled: true
    endpoint: http://jaeger:14268
    service_name: miniblog
    
  # 日志配置
  logging:
    level: info
    output: /var/log/app/app.log
    format: json
```

## 🔧 故障排除

### 1. 服务启动失败

```bash
# 查看详细启动日志
docker compose -f docker-compose.env.yml logs

# 查看特定服务日志
docker compose -f docker-compose.env.yml logs mysql
docker compose -f docker-compose.env.yml logs redis
docker compose -f docker-compose.env.yml logs kafka

# 检查端口占用
lsof -i :3306   # MySQL
lsof -i :6379   # Redis
lsof -i :9092   # Kafka
lsof -i :8080   # Kafka UI
lsof -i :9200   # Elasticsearch
lsof -i :5601   # Kibana
lsof -i :9090   # Prometheus
lsof -i :3000   # Grafana
lsof -i :16686  # Jaeger

# 检查 Docker 状态
docker info
```

### 2. 数据库连接问题

```bash
# 检查 MySQL 服务状态
docker exec miniblog-mysql mysqladmin ping -h localhost -u root -pj478EaZGDNPUbnXb

# 查看 MySQL 错误日志
docker logs miniblog-mysql

# 检查数据库是否存在
docker exec miniblog-mysql mysql -u root -pj478EaZGDNPUbnXb -e "SHOW DATABASES;"
```

### 3. Redis 连接问题

```bash
# 检查 Redis 服务状态
docker exec miniblog-redis redis-cli -a weZ2014P89rlTuWe ping

# 查看 Redis 配置
docker exec miniblog-redis redis-cli -a weZ2014P89rlTuWe CONFIG GET "*"

# 查看 Redis 日志
docker logs miniblog-redis
```

### 4. Kafka 连接问题

```bash
# 检查 Kafka 服务状态
docker exec miniblog-kafka kafka-topics --bootstrap-server localhost:9092 --list

# 查看 Zookeeper 状态
docker exec miniblog-zookeeper zkServer.sh status

# 查看 Kafka 日志
docker logs miniblog-kafka
```

### 5. 可观测性组件问题

```bash
# 检查 Elasticsearch 状态
curl -X GET "localhost:9200/_cluster/health"

# 检查 Prometheus 状态
curl http://localhost:9090/-/healthy

# 查看 Grafana 日志
docker logs miniblog-grafana

# 查看 Jaeger 日志
docker logs miniblog-jaeger

# 查看 Filebeat 状态
docker logs miniblog-filebeat
```

### 6. 网络连接问题

```bash
# 检查网络状态
docker network ls

# 检查 dev_miniblog-network 网络详情
docker network inspect dev_miniblog-network

# 确认基础环境网络是否创建
docker compose -f docker-compose.env.yml ps

# 如果应用服务无法启动，检查网络是否存在
docker network ls | grep miniblog

# 测试容器间连通性（基础环境内）
docker exec miniblog-mysql ping redis
docker exec miniblog-redis ping kafka
docker exec miniblog-elasticsearch ping prometheus

# 测试应用服务与基础服务的连通性（需要两个环境都启动）
docker exec miniblog-user-api ping mysql
docker exec miniblog-user-rpc ping redis
```

### 7. 启动顺序问题

```bash
# 错误：如果先启动应用服务会报网络不存在错误
# Error: network dev_miniblog-network not found

# 解决方案：按正确顺序启动
# 1. 停止所有服务
make dev-stop
make env-stop

# 2. 按顺序重新启动
make env-start    # 先启动基础环境
sleep 30          # 等待基础服务就绪
make dev          # 再启动应用服务
```

## 🔒 安全注意事项

### 开发环境安全

当前配置适用于开发环境，包含以下安全措施：

- Redis 设置了访问密码
- MySQL 创建了专用应用用户
- 管理界面设置了访问控制

### 生产环境建议

⚠️ **生产环境部署时请注意**：

1. **密码安全**
   - 使用强密码（16位以上，包含大小写、数字、特殊字符）
   - 定期更换密码
   - 使用密钥管理系统

2. **网络安全**
   - 不要暴露不必要的端口
   - 使用防火墙限制访问
   - 启用 SSL/TLS 加密

3. **访问控制**
   - 配置 Kafka SASL 认证
   - 限制管理界面访问 IP
   - 使用 VPN 或跳板机

4. **数据安全**
   - 定期备份数据
   - 启用数据加密
   - 设置数据保留策略

## 🛠️ 高级操作

### 数据备份与恢复

```bash
# 备份 MySQL 数据库
docker exec miniblog-mysql mysqldump -u root -pj478EaZGDNPUbnXb miniblog > backup_$(date +%Y%m%d_%H%M%S).sql

# 恢复 MySQL 数据库
docker exec -i miniblog-mysql mysql -u root -pj478EaZGDNPUbnXb miniblog < backup_20250815_120000.sql

# 备份 Redis 数据
docker exec miniblog-redis redis-cli -a weZ2014P89rlTuWe BGSAVE
echo "Redis 数据已备份到容器内的 /data/dump.rdb"

# 导出 Redis 数据到本地
docker cp miniblog-redis:/data/dump.rdb ./redis_backup_$(date +%Y%m%d_%H%M%S).rdb
```

### 环境重置

```bash
# 完全重置环境（会删除所有数据）
docker compose -f docker-compose.env.yml down -v

# 清理系统资源
docker system prune -f

# 清理未使用的镜像
docker image prune -f

# 清理未使用的数据卷
docker volume prune -f
```

### 监控和调试

```bash
# 查看资源使用情况
docker stats --no-stream

# 查看容器详细信息
docker inspect miniblog-mysql
docker inspect miniblog-redis
docker inspect miniblog-kafka

# 查看系统信息
docker system df
docker version
docker info
```

## 📚 相关资源

### 官方文档

- [MySQL 8.0 官方文档](https://dev.mysql.com/doc/refman/8.0/en/)
- [Redis 官方文档](https://redis.io/documentation)
- [Apache Kafka 官方文档](https://kafka.apache.org/documentation/)
- [Docker Compose 官方文档](https://docs.docker.com/compose/)

### 管理工具

- [Kafka UI](https://github.com/provectus/kafka-ui) - Kafka 管理界面

### 学习资源

- [Docker 入门教程](https://docs.docker.com/get-started/)
- [MySQL 性能优化指南](https://dev.mysql.com/doc/refman/8.0/en/optimization.html)
- [Redis 最佳实践](https://redis.io/docs/manual/patterns/)
- [Kafka 设计原理](https://kafka.apache.org/intro)

## 🎯 总结

✨ **完整的微服务开发环境搭建完成！**

### 🏗️ 完整技术栈

#### 基础服务

- **MySQL 8.0**: 关系型数据库
- **Redis 7**: 内存缓存
- **Kafka 7.4.0**: 消息队列

#### 可观测性套件  

- **📊 指标监控**: Prometheus + Grafana
- **📝 日志分析**: ELK Stack (Elasticsearch + Kibana) + Filebeat + go-stash
- **🔍 链路追踪**: Jaeger

### 🎨 优势特点

- 🚀 **一条命令启动**: `docker compose -f docker-compose.env.yml up -d`
- 📁 **单文件配置**: 所有配置集中在一个文件中
- 🔧 **零依赖**: 无需额外的脚本、Makefile 或配置文件
- 📚 **学习成本低**: 只需掌握基本的 Docker Compose 命令
- 🛠️ **维护简单**: 修改配置只需编辑一个文件
- 👁️ **完整可观测性**: 指标、日志、追踪三大支柱全覆盖

### 下一步

环境搭建完成后，您可以：

1. **开发应用**: 使用配置好的数据库和消息队列
2. **性能测试**: 在本地环境进行压力测试  
3. **功能测试**: 验证各项功能的完整性
4. **部署准备**: 为生产环境部署做准备
