# 统一响应结构

本文档描述项目统一的 HTTP 响应结构与使用方式，基于 go-zero，并参考官方扩展用法（见 [HTTP 扩展](https://go-zero.dev/docs/tutorials/http/server/response/ext)）。

## 响应结构体

所有接口均返回以下结构：

```json
{
  "code": 0,
  "message": "response message",
  "data": any,
  "reason": any
}
```

- 成功：

```json
{
  "code": 0,
  "message": "ok",
  "data": {"...": "..."},
  "reason": null
}
```

- 失败（示例：资源未找到）：

```json
{
  "code": 404,
  "message": "Not Found",
  "data": null,
  "reason": "错误信息或上下文"
}
```

- 参数校验失败：

```json
{
  "code": 0,
  "message": "参数校验失败",
  "data": null,
  "reason": ["字段 'Email' 验证失败: 邮箱格式不正确 (值: final-direct-testexample.com)"]
}
```

## 封装位置

- 封装代码：`pkg/response/response.go`
- 响应结构：`BaseResponse{ code, message, data, reason }`
- 提供方法：
  - `response.SuccessCtx(ctx, w, message, data, reason)`
  - `response.FailCtx(ctx, w, code, message, reason)`
  - `response.NotFoundCtx(ctx, w, reason)`
  - `response.JsonBaseResponseCtx(ctx, w, v)`（统一入口，兼容成功对象与 error）

## 在 handler 中的使用示例

推荐将 go-zero 生成的 `httpx.ErrorCtx/OkJsonCtx` 替换为统一入口：

```go
import (
    "github.com/clin211/miniblog-v3/pkg/response"
    "github.com/zeromicro/go-zero/rest/httpx"
)

func SomeHandler(svcCtx *svc.ServiceContext) http.HandlerFunc {
    return func(w http.ResponseWriter, r *http.Request) {
        var req types.SomeRequest
        if err := httpx.Parse(r, &req); err != nil {
            response.JsonBaseResponseCtx(r.Context(), w, err)
            return
        }

        l := logic.NewSomeLogic(r.Context(), svcCtx)
        resp, err := l.Do(&req)
        if err != nil {
            response.JsonBaseResponseCtx(r.Context(), w, err)
            return
        }

        response.JsonBaseResponseCtx(r.Context(), w, resp)
    }
}
```

如需自定义 message 或 reason，可使用 `SuccessCtx/FailCtx`：

```go
response.SuccessCtx(r.Context(), w, "response message", resp, map[string]any{"traceId":"..."})
response.FailCtx(r.Context(), w, 404, "Not Found", "user id not found")
```

## 说明

- 统一入口 `JsonBaseResponseCtx` 会对 `validate.ValidationErrors` 进行特殊处理，自动将校验错误转换为 `[]string` 放入 `reason`。
- 其他任意 `error` 会被包装为 `{code: 404, message: "Not Found", data: null, reason: err.Error()}`，如需不同的业务码/提示，可直接调用 `FailCtx`。
